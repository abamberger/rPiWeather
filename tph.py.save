from Adafruit_BMP085 import BMP085
from smbus import SMBus
import time
import psycopg2
import datetime
import numpy as np

time.sleep(10)

#con = psycopg2.connect(database='weather', user='alex')
#cur = con.cursor()

con = psycopg2.connect(host='10.0.0.249', database='weather', user='met', password='metp@ss')
cur = con.cursor()

tempparr = np.array([])
pressurearr = np.array([])
tempharr = np.array([])
humidarr = np.array([])

bmp = BMP085(0x77)

HIH6130 = SMBus(1)
var = [0, 0, 0, 0]

insert = 0
now=datetime.datetime.now()

while True:
	try:
		while now.minute%10 <> 0 or insert == 1:
			time.sleep(30)
			#BMP180 Read
			tempp = bmp.readTemperature()
			pressure = bmp.readPressure()/100.00
			#HIH6130 Read
			HIH6130.write_quick(0x27)
			time.sleep(0.050)
			var = HIH6130.read_i2c_block_data(0x27, 0)
			status = (var[0] & 0xc0) >> 6
			humidity = (((var[0] & 0x3f) << 8) + var[1]) * 100.0 / 16383.0
			temph = ((var[2] << 6) + ((var[3] & 0xfc) >> 2)) * 165.0 / 16383.0 - 40.0
			#Store in arrays
			if tempp < 50 and pressure > 700 and pressure < 900:
				tempparr = np.append(tempparr,tempp)
				pressurearr = np.append(pressurearr,pressure)
			if temph < 50 and humidity > -1 and humidity < 101:
				tempharr = np.append(tempharr, temph)
				humidarr = np.append(humidarr,humidity)
			#Temp print
			#print(np.mean(humidarr))
			#print(temph)
			now=datetime.datetime.now()
			if insert == 1 and now.minute%10 <> 0:
				insert = 0
		#calculate means of 30sec arrays
		temppi = np.mean(tempparr)
		temphi = np.mean(tempharr)
		humidi = np.mean(humidarr)
		pressurei = np.mean(pressurearr)
		dpti = 243.04*(np.log(humidi/100.0)+((17.625*temppi)/(243.04+temppi)))/(17.625-np.log(humidi/100.0)-((17.625*temppi)/(243.04+temppi)))
		slpi = pressurei*np.exp(1637.0/(29.3*(temppi+273)))
		#insert into db
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 1, %s)' % (temppi))
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 2, %s)' % (temphi))
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 7, %s)' % (humidi))
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 8, %s)' % (pressurei))
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 9, %s)' % (round(dpti,4)))
		cur.execute('insert into stationdata values (round_10min(localtimestamp + interval \'1 second\'), 10, %s)' % (round(slpi,4)))
		con.commit()
		#Clear 30 second arrays for next cycle
		tempparr = np.array([])
		pressurearr = np.array([])
		tempharr = np.array([])
		humidarr = np.array([])
		insert = 1
		now=datetime.datetime.now()
	except KeyboardInterrupt:
		con.close()
		raise



